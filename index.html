<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Video Creator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .form-container {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            height: 120px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .submit-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .story-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .generate-story-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .generate-story-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .generate-story-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .media-container {
            margin-top: 20px;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e1e5e9;
        }

        .media-container video,
        .media-container img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .media-container .media-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .download-btn {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
            font-size: 1.5rem;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #333;
        }

        .settings-form-group {
            margin-bottom: 20px;
        }

        .settings-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .settings-form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1rem;
        }

        .settings-form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .save-settings-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .save-settings-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .status-container {
            display: none;
            padding: 20px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .result {
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .form-container {
                padding: 30px 20px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <button class="settings-btn" id="settingsBtn">‚öôÔ∏è</button>
            <h1>üé¨ AI Video Creator</h1>
            <p>Create engaging videos with Seedance AI</p>
        </div>

        <div class="form-container">
            <form id="videoForm">
                <div class="form-group">
                    <div class="story-controls">
                        <label for="story">Story *</label>
                        <button type="button" class="generate-story-btn" id="generateStoryBtn">‚ú® Generate Random
                            Story</button>
                    </div>
                    <textarea id="story" name="Story" placeholder="Tell your story... What happens in your video?"
                        required></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="scenes">Number of Scenes</label>
                        <input type="number" id="scenes" name="Number of scenes" value="5" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label for="duration">Duration (seconds)</label>
                        <select id="duration" name="Duration" required>
                            <option value="5">5 seconds</option>
                            <option value="10">10 seconds</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="aspectRatio">Aspect Ratio</label>
                        <select id="aspectRatio" name="Aspect ratio" required>
                            <option value="16:9">16:9 (Landscape)</option>
                            <option value="9:16">9:16 (Portrait)</option>
                            <option value="1:1">1:1 (Square)</option>
                            <option value="4:3">4:3 (Standard)</option>
                            <option value="3:4">3:4 (Portrait)</option>
                            <option value="21:9">21:9 (Ultrawide)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="resolution">Resolution</label>
                        <select id="resolution" name="Resolution" required>
                            <option value="480p">480p</option>
                            <option value="1080p">1080p</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="submit-btn">Create Video</button>
            </form>

            <div class="status-container" id="statusContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p id="statusText">Initializing video creation...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
                <div class="result" id="result" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
                <span class="close" id="closeModal">&times;</span>
            </div>
            <div class="settings-form-group">
                <label for="webhookUrl">Webhook URL</label>
                <input type="url" id="webhookUrl" placeholder="https://your-n8n-instance.com/webhook-test/story-time">
            </div>
            <button class="save-settings-btn" id="saveSettings">Save Settings</button>
        </div>
    </div>

    <script>
        // n8n webhook URL - can be updated via settings
        let WEBHOOK_URL = localStorage.getItem('webhookUrl') || 'https://n8n2.geekhouse.io/webhook-test/story-time';
        let RESUME_WEBHOOK_URL = WEBHOOK_URL;

        // Google Gemini API configuration
        const GEMINI_API_KEY = 'AIzaSyCSAquXebiwOSJWMsJ-z5ZTN4JPzAnTjXo';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

        let currentJobId = null;

        document.getElementById('videoForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            // Convert number of scenes to number
            data['Number of scenes'] = parseInt(data['Number of scenes']) || 5;

            // Show status container
            document.getElementById('statusContainer').style.display = 'block';
            document.getElementById('result').style.display = 'none';
            document.querySelector('.submit-btn').disabled = true;

            try {
                console.log('Sending data to webhook:', data);
                // Submit to n8n webhook
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                console.log('Response status:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('Webhook response:', result);

                    if (result.mediaURL) {
                        updateStatus('Video created successfully!', 100);
                        displayMedia(result.mediaURL);
                    } else {
                        updateStatus('Video creation started! Processing scenes...', 10);
                        // Start polling for completion if no immediate media URL
                        pollForCompletion();
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Webhook error:', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('Error:', error);
                showResult(`Failed to start video creation: ${error.message}. Please try again.`, 'error');
                resetForm();
            }
        });

        function updateStatus(text, progress) {
            document.getElementById('statusText').textContent = text;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function pollForCompletion() {
            let attempts = 0;
            const maxAttempts = 120; // 10 minutes max (5 second intervals)

            const pollInterval = setInterval(async () => {
                attempts++;

                try {
                    // Try to resume the webhook to check if it's complete
                    const response = await fetch(RESUME_WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            jobId: currentJobId,
                            action: 'check_status'
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();

                        if (result.status === 'completed') {
                            clearInterval(pollInterval);
                            updateStatus('Video created successfully!', 100);
                            showResult('Your video has been created successfully! ' +
                                (result.videoUrl ? `<a href="${result.videoUrl}" target="_blank">Download Video</a>` : ''), 'success');
                            resetForm();
                        } else if (result.status === 'failed') {
                            clearInterval(pollInterval);
                            showResult('Video creation failed: ' + (result.error || 'Unknown error'), 'error');
                            resetForm();
                        } else {
                            // Still processing
                            const progress = Math.min(10 + (attempts * 2), 90);
                            updateStatus(result.message || 'Processing...', progress);
                        }
                    } else if (response.status === 404) {
                        // Webhook not found yet, keep waiting
                        const progress = Math.min(10 + (attempts * 2), 90);
                        updateStatus('Processing scenes and generating images...', progress);
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                    // Continue polling unless max attempts reached
                }

                if (attempts >= maxAttempts) {
                    clearInterval(pollInterval);
                    showResult('Video creation is taking longer than expected. Please check back later.', 'error');
                    resetForm();
                }
            }, 5000); // Poll every 5 seconds
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = message;
            resultDiv.className = `result ${type}`;
            resultDiv.style.display = 'block';
        }

        function resetForm() {
            // Hide the status container (loading state)
            document.getElementById('statusContainer').style.display = 'none';
            // Re-enable the submit button
            document.querySelector('.submit-btn').disabled = false;
            // Reset progress bar
            document.getElementById('progressFill').style.width = '0%';
            // Clear job ID
            currentJobId = null;
        }

        function displayMedia(mediaURL) {
            const resultDiv = document.getElementById('result');

            // Determine if it's a video or image based on URL
            const isVideo = mediaURL.includes('.mp4') || mediaURL.includes('.mov') || mediaURL.includes('.webm') || mediaURL.includes('video');

            let mediaHTML = '';
            if (isVideo) {
                mediaHTML = `
                    <div class="media-container">
                        <div class="media-title">üé¨ Your AI Generated Video</div>
                        <video controls style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);" preload="metadata">
                            <source src="${mediaURL}" type="video/mp4">
                            <source src="${mediaURL}" type="video/webm">
                            <source src="${mediaURL}" type="video/mov">
                            Your browser does not support the video tag. <a href="${mediaURL}" target="_blank">Click here to view</a>
                        </video>
                        <br>
                        <a href="${mediaURL}" download class="download-btn">üì• Download Video</a>
                    </div>
                `;
            } else {
                mediaHTML = `
                    <div class="media-container">
                        <div class="media-title">üñºÔ∏è Your AI Generated Image</div>
                        <img src="${mediaURL}" alt="Generated content" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);" onload="this.style.opacity=1" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" style="opacity: 0; transition: opacity 0.3s;">
                        <div style="display: none; padding: 20px; background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; border-radius: 6px; margin: 10px 0;">
                            Failed to load image. <a href="${mediaURL}" target="_blank">Click here to view</a>
                        </div>
                        <br>
                        <a href="${mediaURL}" download class="download-btn">üì• Download Image</a>
                    </div>
                `;
            }

            resultDiv.innerHTML = mediaHTML;
            resultDiv.className = 'result success';
            resultDiv.style.display = 'block';

            // Re-enable the form for creating another video
            document.querySelector('.submit-btn').disabled = false;
        }

        // Generate random story using Google Gemini
        document.getElementById('generateStoryBtn').addEventListener('click', async function () {
            const button = this;
            const storyTextarea = document.getElementById('story');

            // Disable button and show loading state
            button.disabled = true;
            button.textContent = 'üîÑ Generating...';

            try {
                console.log('Calling Gemini API...');
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-goog-api-key': GEMINI_API_KEY,
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: "Generate a creative and engaging short story suitable for a video (2-3 sentences). The story should be visual, emotional, and perfect for video creation. Include vivid scenes and actions that can be easily visualized. Make it compelling and suitable for social media video content."
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.9,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 200,
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            }
                        ]
                    })
                });

                console.log('Response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('API Response:', data);

                    if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts[0]) {
                        const generatedStory = data.candidates[0].content.parts[0].text;
                        storyTextarea.value = generatedStory.trim();

                        // Add a subtle animation to show the story was updated
                        storyTextarea.style.backgroundColor = '#e8f5e8';
                        setTimeout(() => {
                            storyTextarea.style.backgroundColor = '';
                        }, 1000);
                    } else {
                        throw new Error('Invalid response structure from API');
                    }
                } else {
                    const errorData = await response.text();
                    console.error('API Error:', errorData);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorData}`);
                }
            } catch (error) {
                console.error('Error generating story:', error);
                alert(`Failed to generate story: ${error.message}. Please try again or write your own story.`);
            } finally {
                // Reset button state
                button.disabled = false;
                button.textContent = '‚ú® Generate Random Story';
            }
        });

        // Settings Modal functionality
        const settingsModal = document.getElementById('settingsModal');
        const settingsBtn = document.getElementById('settingsBtn');
        const closeModal = document.getElementById('closeModal');
        const saveSettings = document.getElementById('saveSettings');
        const webhookUrlInput = document.getElementById('webhookUrl');

        // Load current webhook URL into the input
        webhookUrlInput.value = WEBHOOK_URL;

        // Open settings modal
        settingsBtn.addEventListener('click', function() {
            settingsModal.style.display = 'block';
            webhookUrlInput.value = WEBHOOK_URL;
        });

        // Close modal
        closeModal.addEventListener('click', function() {
            settingsModal.style.display = 'none';
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
        });

        // Save settings
        saveSettings.addEventListener('click', function() {
            const newWebhookUrl = webhookUrlInput.value.trim();
            
            if (newWebhookUrl) {
                // Update the webhook URLs
                WEBHOOK_URL = newWebhookUrl;
                RESUME_WEBHOOK_URL = newWebhookUrl;
                
                // Save to localStorage
                localStorage.setItem('webhookUrl', newWebhookUrl);
                
                // Close modal
                settingsModal.style.display = 'none';
                
                // Show confirmation
                alert('Settings saved successfully!');
            } else {
                alert('Please enter a valid webhook URL');
            }
        });
    </script>
</body>

</html>